# Cilium Network Security Policies

---
# Default deny-all policy for kube-system namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: kube-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# Allow Cloudflare Tunnel and Tailscale clients to reach Gateway API (HTTP/HTTPS)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cloudflare-to-gateway
  namespace: kube-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: cloudflare-operator-system
    - ipBlock:
        cidr: 100.64.0.0/10
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443

---
# Allow Cilium Agent communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cilium-agent
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      k8s-app: cilium
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow Gateway API traffic from Cloudflare Tunnel and Tailscale
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: cloudflare-operator-system
    - ipBlock:
        cidr: 100.64.0.0/10
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  # Allow health checks
  - from:
    - podSelector:
        matchLabels:
          k8s-app: cilium
    ports:
    - protocol: TCP
      port: 9876
  # Allow Hubble metrics
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 9965
  # Allow Cilium API
  - from:
    - podSelector:
        matchLabels:
          io.cilium/app: operator
    ports:
    - protocol: TCP
      port: 9962
  egress:
  # Allow DNS
  - to:
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow API server communication
  - to: []
    ports:
    - protocol: TCP
      port: 6443
  # Allow ETCD communication
  - to: []
    ports:
    - protocol: TCP
      port: 2379
    - protocol: TCP
      port: 2380
  # Allow inter-agent communication
  - to:
    - podSelector:
        matchLabels:
          k8s-app: cilium
    ports:
    - protocol: TCP
      port: 9962
  # Allow WireGuard tunnels
  - to: []
    ports:
    - protocol: UDP
      port: 51871

---
# Allow Cilium Operator communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cilium-operator
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      io.cilium/app: operator
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow metrics scraping
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 9963
  egress:
  # Allow DNS
  - to:
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow API server communication
  - to: []
    ports:
    - protocol: TCP
      port: 6443
  # Allow communication with Cilium agents
  - to:
    - podSelector:
        matchLabels:
          k8s-app: cilium
    ports:
    - protocol: TCP
      port: 9962

---
# Allow CoreDNS communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: coredns
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      k8s-app: kube-dns
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow DNS queries from all pods
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow health checks
  - from:
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: TCP
      port: 8080
  # Allow metrics scraping
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 9153
  egress:
  # Allow upstream DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow API server communication for service discovery
  - to: []
    ports:
    - protocol: TCP
      port: 6443

---
# Allow hostNetwork pods (nodelocal-dns, kubelet probes) to reach CoreDNS.
# KubeSpan delivers this traffic with Cilium's "remote-node" identity,
# which namespaceSelector:{} in the K8s NetworkPolicy doesn't match.
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: coredns-allow-host
  namespace: kube-system
spec:
  endpointSelector:
    matchLabels:
      k8s-app: kube-dns
  ingress:
  - fromEntities:
    - host
    - remote-node
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
      - port: "9153"
        protocol: TCP
      - port: "8080"
        protocol: TCP

---
# Allow Hubble Relay communication (if deployed)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hubble-relay
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      k8s-app: hubble-relay
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow gRPC API access
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 4245
  egress:
  # Allow DNS resolution
  - to:
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow communication with hubble-peer service (Cilium agents on host network)
  - ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 4244
