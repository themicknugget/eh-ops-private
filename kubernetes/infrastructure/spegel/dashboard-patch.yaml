---
apiVersion: v1
kind: ConfigMap
metadata:
  name: spegel-grafana-dashboard
  namespace: spegel
  labels:
    grafana_dashboard: "1"
    app.kubernetes.io/name: spegel
    app.kubernetes.io/instance: spegel
  annotations:
    grafana_folder: Infrastructure
data:
  spegel.json: |
    {"__inputs":[],"__elements":{},"__requires":[{"type":"grafana","id":"grafana","name":"Grafana","version":"9.3.6"},{"type":"datasource","id":"prometheus","name":"Prometheus","version":"1.0.0"},{"type":"panel","id":"stat","name":"Stat","version":""},{"type":"panel","id":"table","name":"Table","version":""},{"type":"panel","id":"text","name":"Text","version":""},{"type":"panel","id":"timeseries","name":"Time series","version":""}],"annotations":{"list":[{"builtIn":1,"datasource":{"type":"grafana","uid":"-- Grafana --"},"enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations & Alerts","type":"dashboard"}]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"id":null,"links":[],"liveNow":false,"panels":[{"collapsed":false,"gridPos":{"h":1,"w":24,"x":0,"y":0},"id":18,"panels":[],"title":"Spegel","type":"row"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}},"overrides":[]},"gridPos":{"h":4,"w":4,"x":0,"y":1},"id":2,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"code","expr":"count(spegel_advertised_keys{instance=~\"$instance\"})","legendFormat":"__auto","range":true,"refId":"A"}],"title":"Registry","type":"stat"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}},"overrides":[]},"gridPos":{"h":4,"w":4,"x":4,"y":1},"id":15,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"code","expr":"sum(kubelet_node_name{job=\"kubelet\"})","legendFormat":"__auto","range":true,"refId":"A"}],"title":"Running Nodes","type":"stat"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}},"overrides":[]},"gridPos":{"h":4,"w":4,"x":8,"y":1},"id":14,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"code","expr":"sum(kubelet_running_containers)","legendFormat":"__auto","range":true,"refId":"A"}],"title":"Running Containers","type":"stat"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}},"overrides":[]},"gridPos":{"h":4,"w":4,"x":12,"y":1},"id":16,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"code","expr":"sum(kubelet_running_pods)","legendFormat":"__auto","range":true,"refId":"A"}],"title":"Running Pods","type":"stat"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"#EAB839","value":50},{"color":"red","value":100}]}},"overrides":[]},"gridPos":{"h":4,"w":4,"x":16,"y":1},"id":17,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"code","expr":"max(rate(http_request_duration_seconds_bucket{job=\"spegel\"}[$__interval]))","legendFormat":"__auto","range":true,"refId":"A"}],"title":"Max Request Duration","type":"stat"},{"gridPos":{"h":4,"w":4,"x":20,"y":1},"id":19,"options":{"code":{"language":"plaintext","showLineNumbers":false,"showMiniMap":false},"content":"\n[Spegel at GitHub](https://github.com/XenitAB/spegel)","mode":"markdown"},"pluginVersion":"9.3.6","title":"Github link","type":"text"},{"collapsed":false,"gridPos":{"h":1,"w":24,"x":0,"y":5},"id":20,"panels":[],"title":"","type":"row"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"gridPos":{"h":8,"w":12,"x":0,"y":6},"id":4,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"bottom","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"builder","expr":"spegel_advertised_images{job=~\"spegel\",instance=~\"$instance\"}","legendFormat":"{{pod}} / {{registry}}","range":true,"refId":"A"}],"title":"","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"custom":{"align":"auto","cellOptions":{"type":"auto"},"inspect":false},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"gridPos":{"h":8,"w":6,"x":12,"y":6},"id":6,"options":{"footer":{"countRows":false,"fields":"","reducer":["sum"],"show":false},"showHeader":true},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"builder","expr":"spegel_advertised_images{job=~\"spegel\",instance=~\"$instance\"}","legendFormat":"__auto","range":true,"refId":"A"}],"title":"Container Images Advertised ","type":"table"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"gridPos":{"h":8,"w":12,"x":0,"y":14},"id":8,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"bottom","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"code","expr":"sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{container=\"$container\"}) by (pod)","legendFormat":"{{pod}}","range":true,"refId":"A"}],"title":"CPU Usage","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"custom":{"align":"auto","cellOptions":{"type":"auto"},"inspect":false},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"gridPos":{"h":8,"w":6,"x":12,"y":14},"id":10,"options":{"footer":{"countRows":false,"fields":"","reducer":["sum"],"show":false},"showHeader":true},"pluginVersion":"9.3.6","targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"builder","expr":"spegel_advertised_keys{job=~\"spegel\",instance=~\"$instance\"} ","legendFormat":"__auto","range":true,"refId":"A"}],"title":"Images Layer Advertised ","type":"table"},{"collapsed":false,"gridPos":{"h":1,"w":24,"x":0,"y":22},"id":22,"panels":[],"title":"Kubelet","type":"row"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"gridPos":{"h":8,"w":12,"x":0,"y":23},"id":12,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"bottom","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"code","expr":"sum(rate(kubelet_runtime_operations_total{job=\"kubelet\", metrics_path=\"/metrics\", operation_type=~\"list_podsandbox|list_containers|image_status|list_images\"}[$__rate_interval])) by (instance, operation_type)","legendFormat":"{{instance}} / {{operation_type}}","range":true,"refId":"A"}],"title":"Kubelet Operation Rate","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"$datasource"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"gridPos":{"h":8,"w":12,"x":12,"y":23},"id":13,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"bottom","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"$datasource"},"editorMode":"code","expr":"sum(rate(kubelet_runtime_operations_errors_total{job=\"kubelet\", metrics_path=\"/metrics\",operation_type=~\"list_podsandbox|list_containers|image_status|list_images\"}[$__rate_interval])) by (instance, operation_type)","legendFormat":"{{instance}} / {{operation_type}}","range":true,"refId":"A"}],"title":"Kubelet Operation Error Rate","type":"timeseries"}],"refresh":"30s","schemaVersion":37,"style":"dark","tags":[],"templating":{"list":[{"current":{"selected":false,"text":"Prometheus","value":"Prometheus"},"hide":0,"includeAll":false,"label":"Data Source","multi":false,"name":"datasource","options":[],"query":"prometheus","refresh":1,"regex":"","skipUrlSync":false,"type":"datasource"},{"current":{"selected":false,"text":"registry","value":"registry"},"hide":0,"includeAll":false,"multi":false,"name":"container","options":[{"selected":true,"text":"registry","value":"registry"}],"query":"registry","skipUrlSync":false,"type":"custom"},{"current":{},"datasource":{"type":"prometheus","uid":"$datasource"},"definition":"label_values(spegel_advertised_images,pod)","hide":0,"includeAll":false,"multi":false,"name":"pod","options":[],"query":{"query":"label_values(spegel_advertised_images,pod)","refId":"StandardVariableQuery"},"refresh":1,"regex":"","skipUrlSync":false,"sort":0,"type":"query"},{"current":{},"datasource":{"type":"prometheus","uid":"$datasource"},"definition":"label_values(spegel_advertised_keys,instance) ","hide":0,"includeAll":true,"multi":false,"name":"instance","options":[],"query":{"query":"label_values(spegel_advertised_keys,instance) ","refId":"StandardVariableQuery"},"refresh":1,"regex":"","skipUrlSync":false,"sort":0,"type":"query"}]},"time":{"from":"now-3h","to":"now"},"timepicker":{},"timezone":"browser","title":"Spegel stateless cluster local OCI registry mirror","uid":"1iY4QMJVk-psee","version":1,"weekStart":""}
