{{- if and .Values.name .Values.download.enabled -}}
{{- $modelDir := .Values.storage.modelDir | default .Values.name -}}
{{- $sharedPvc := .Values.storage.sharedPvc | default "model-cache" -}}
# Launcher Job - creates the actual download job and exits
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.name }}-download
  labels:
    {{- include "inference-model.labels" . | nindent 4 }}
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "inference-model.labels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ .Values.name }}-download-launcher
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      restartPolicy: OnFailure
      containers:
        - name: launcher
          image: python:3.11-slim
          command:
            - sh
            - -c
            - |
              set -ex

              # Force unbuffered Python output
              export PYTHONUNBUFFERED=1

              # Download kubectl using Python
              python3 -c "
              import urllib.request
              import os
              url = 'https://dl.k8s.io/release/stable.txt'
              version = urllib.request.urlopen(url).read().decode().strip()
              kubectl_url = f'https://dl.k8s.io/release/{version}/bin/linux/amd64/kubectl'
              print(f'Downloading kubectl {version}...')
              urllib.request.urlretrieve(kubectl_url, '/tmp/kubectl')
              print('Download complete')
              "
              chmod +x /tmp/kubectl
              echo "kubectl ready"

              MODEL_DIR=/models/{{ $modelDir }}
              JOB_NAME={{ .Values.name }}-download-worker
              NAMESPACE={{ .Release.Namespace }}

              # Use downloaded kubectl
              export PATH="/tmp:$PATH"

              # Check if already downloaded - fast exit
              if [ -f "${MODEL_DIR}/.ready" ]; then
                echo "Model already downloaded"
                exit 0
              fi

              echo "Ensuring download worker job is running..."

              # Delete any existing worker job (and its pods)
              kubectl delete job "${JOB_NAME}" -n "${NAMESPACE}" --ignore-not-found=true --force --grace-period=0 2>/dev/null || true

              # Wait for pods to be cleaned up
              sleep 2

              # Create the actual download job
              cat <<JOBEOF | kubectl apply -f -
              apiVersion: batch/v1
              kind: Job
              metadata:
                name: ${JOB_NAME}
                namespace: ${NAMESPACE}
                labels:
                  app.kubernetes.io/name: {{ .Values.name }}
                  app.kubernetes.io/component: download-worker
                  app.kubernetes.io/managed-by: {{ .Values.name }}-download
              spec:
                backoffLimit: 3
                ttlSecondsAfterFinished: 300
                template:
                  metadata:
                    labels:
                      app.kubernetes.io/name: {{ .Values.name }}
                      app.kubernetes.io/component: download-worker
                  spec:
                    nodeSelector:
              {{- with .Values.nodeSelector }}
              {{- range $key, $value := . }}
                      {{ $key }}: {{ $value }}
              {{- end }}
              {{- end }}
                    tolerations:
              {{- with .Values.tolerations }}
              {{- range . }}
                      - key: {{ .key }}
                        operator: {{ .operator }}
              {{- end }}
              {{- end }}
                    restartPolicy: OnFailure
                    containers:
                      - name: download
                        image: python:3.11-slim
                        command:
                          - sh
                          - -c
                          - |
                            set -e

                            # Install huggingface-cli with CLI extras
                            pip install --user "huggingface_hub[cli]" hf-transfer
                            export PATH="/tmp/.local/bin:\$PATH"
                            export HF_HUB_ENABLE_HF_TRANSFER=1

                            MODEL_DIR=/models/{{ $modelDir }}

                            # Check if already downloaded
                            if [ -f "\${MODEL_DIR}/.ready" ]; then
                              echo "Model already downloaded"
                              exit 0
                            fi

                            # Acquire global download lock (only one model downloads at a time).
                            # mkdir is atomic on POSIX filesystems - safe for concurrent pods.
                            # The .downloading files under each model dir show which model holds
                            # the lock; they're heartbeated every minute for staleness detection.
                            LOCK_DIR=/models/.download-lock
                            while true; do
                              if [ -d "\$LOCK_DIR" ]; then
                                last=\$(cat "\$LOCK_DIR/heartbeat" 2>/dev/null || echo 0)
                                now=\$(date +%s)
                                if [ \$((now - last)) -gt 600 ]; then
                                  echo "Removing stale download lock (held for \$((now - last))s)"
                                  rm -rf "\$LOCK_DIR"
                                fi
                              fi
                              if mkdir "\$LOCK_DIR" 2>/dev/null; then
                                echo "Download lock acquired"
                                break
                              fi
                              # Show which model is currently downloading
                              active=\$(find /models -maxdepth 2 -name '.downloading' 2>/dev/null \
                                | sed 's|/models/||;s|/.downloading||' | tr '\n' ' ')
                              echo "Waiting for download lock (active: \${active:-unknown})..."
                              sleep 60
                            done
                            trap "rm -rf \$LOCK_DIR" EXIT

                            # Create lock file
                            mkdir -p "\${MODEL_DIR}"
                            touch "\${MODEL_DIR}/.downloading"

                            # Background: update lock timestamps every minute
                            while true; do
                              touch "\${MODEL_DIR}/.downloading"
                              echo "\$(date +%s)" > "\$LOCK_DIR/heartbeat"
                              sleep 60
                            done &
                            heartbeat_pid=\$!

                            # Background: print download progress every 60s with transfer rate
                            last_bytes=0
                            while [ ! -f "\${MODEL_DIR}/.ready" ]; do
                              bytes=\$(du -sb "\${MODEL_DIR}" 2>/dev/null | cut -f1)
                              if [ -n "\$bytes" ] && [ "\$last_bytes" -gt 0 ]; then
                                diff=\$((bytes - last_bytes))
                                size_gb=\$((bytes / 1024 / 1024 / 1024))
                                rate_mb=\$((diff / 60 / 1024 / 1024))
                                if [ "\$rate_mb" -ge 1 ]; then
                                  echo "\${size_gb}G downloaded (~\${rate_mb} MB/s)"
                                else
                                  rate_kb=\$((diff / 60 / 1024))
                                  echo "\${size_gb}G downloaded (~\${rate_kb} KB/s)"
                                fi
                              elif [ -n "\$bytes" ]; then
                                size_gb=\$((bytes / 1024 / 1024 / 1024))
                                echo "\${size_gb}G downloaded"
                              fi
                              last_bytes=\${bytes:-0}
                              sleep 60
                            done &
                            progress_pid=\$!

                            echo "Downloading model to \${MODEL_DIR}..."

                            # Download (hf is resumable)
                            hf download "{{ .Values.source.huggingface }}" \\
                            {{- if .Values.download.include }}
                            {{- range (splitList "," .Values.download.include) }}
                              --include {{ . | trim | quote }} \\
                            {{- end }}
                            {{- end }}
                              --local-dir "\${MODEL_DIR}"

                            # Mark complete
                            kill \$heartbeat_pid \$progress_pid 2>/dev/null || true
                            rm -f "\${MODEL_DIR}/.downloading"
                            touch "\${MODEL_DIR}/.ready"

                            echo "Model downloaded successfully!"
                        env:
                          - name: HF_HOME
                            value: /models
                          - name: HOME
                            value: /tmp
                          {{- if .Values.download.tokenSecret }}
                          - name: HF_TOKEN
                            valueFrom:
                              secretKeyRef:
                                name: {{ .Values.download.tokenSecret }}
                                key: {{ .Values.download.tokenSecretKey | default "token" }}
                          {{- end }}
                        volumeMounts:
                          - name: model-cache
                            mountPath: /models
                          - name: tmp
                            mountPath: /tmp
                    volumes:
                      - name: model-cache
                        persistentVolumeClaim:
                          claimName: {{ $sharedPvc }}
                      - name: tmp
                        emptyDir: {}
              JOBEOF

              echo "Download worker job created successfully!"
          volumeMounts:
            - name: model-cache
              mountPath: /models
      volumes:
        - name: model-cache
          persistentVolumeClaim:
            claimName: {{ $sharedPvc }}
{{- end -}}
