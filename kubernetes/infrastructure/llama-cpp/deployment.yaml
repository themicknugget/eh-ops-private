---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: llama-server
  namespace: llama-cpp
  labels:
    app: llama-server
spec:
  replicas: 1
  strategy:
    type: Recreate  # Required for RWO PVC
  selector:
    matchLabels:
      app: llama-server
  template:
    metadata:
      labels:
        app: llama-server
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      # Schedule on shadow node (AMD Strix Halo GPU)
      nodeSelector:
        workload-type: gpu
      tolerations:
        - key: workload-type
          operator: Equal
          value: heavy
          effect: NoSchedule

      # Low priority so system pods survive OOM pressure
      priorityClassName: gpu-workload-low

      containers:
        - name: llama-server
          image: docker.io/kyuz0/amd-strix-halo-toolboxes:vulkan-radv

          command:
            - llama-server
          args:
            - "--host"
            - "0.0.0.0"
            - "--port"
            - "8080"
            # Router mode - auto-discover models in /models directory
            - "--models-dir"
            - "/models"
            # Use presets file for model-specific settings
            - "--models-preset"
            - "/models/presets.ini"
            # Maximum concurrent models loaded (LRU eviction)
            - "--models-max"
            - "1"
            # Lock model in memory to prevent paging during load
            - "--mlock"

          env:
            # llama.cpp cache for HF downloads - store in PVC
            - name: LLAMA_CACHE
              value: "/models"
            # Vulkan environment for RADV driver
            - name: VK_ICD_FILENAMES
              value: "/usr/share/vulkan/icd.d/radeon_icd.x86_64.json"
            # RADV performance tweaks
            # gpl: Graphics pipeline library (faster shader compilation)
            - name: RADV_PERFTEST
              value: "gpl"
            # Force large Vulkan allocations
            - name: GGML_VK_FORCE_MAX_ALLOCATION_SIZE
              value: "4294967296"

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP

          volumeMounts:
            - name: models
              mountPath: /models
            - name: presets
              mountPath: /models/presets.ini
              subPath: presets.ini
            - name: dev-kfd
              mountPath: /dev/kfd
            - name: dev-dri
              mountPath: /dev/dri

          resources:
            requests:
              memory: "32Gi"
              cpu: "8"
            limits:
              memory: "120Gi"
              cpu: "24"

          securityContext:
            privileged: true  # Required for full GPU access

          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 10

          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5

        # Metrics exporter sidecar - scrapes child servers and adds model labels
        - name: metrics-exporter
          image: python:3.12-alpine
          command:
            - python
            - /scripts/exporter.py
          ports:
            - name: metrics
              containerPort: 9090
              protocol: TCP
          volumeMounts:
            - name: metrics-exporter-script
              mountPath: /scripts
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          livenessProbe:
            httpGet:
              path: /health
              port: 9090
            initialDelaySeconds: 5
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 9090
            initialDelaySeconds: 5
            periodSeconds: 10

      volumes:
        - name: models
          persistentVolumeClaim:
            claimName: llama-models
        - name: presets
          configMap:
            name: llama-presets
        - name: dev-kfd
          hostPath:
            path: /dev/kfd
        - name: dev-dri
          hostPath:
            path: /dev/dri
        - name: metrics-exporter-script
          configMap:
            name: metrics-exporter
            defaultMode: 0755
