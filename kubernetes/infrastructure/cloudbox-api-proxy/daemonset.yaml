---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-api-proxy
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: kube-api-proxy
  template:
    metadata:
      labels:
        app: kube-api-proxy
    spec:
      # Cluster DNS is unreachable from Oracle Cloud (CoreDNS pods are on LAN nodes).
      # Use upstream DNS directly so socat can resolve k8s.whydontyou.work.
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - 1.1.1.1
          - 8.8.8.8
      tolerations:
        - key: node-role.kubernetes.io/edge
          operator: Exists
          effect: NoSchedule
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: eh-ops.io/edge
                    operator: Exists
      containers:
        - name: proxy
          image: alpine/socat:latest
          command: ["socat"]
          # TCP proxy: CiliumLRP redirects kubernetes ClusterIP (10.96.0.1:443) here,
          # socat forwards to the public API endpoint reachable from Oracle Cloud
          args:
            - "TCP4-LISTEN:7446,fork,reuseaddr"
            - "TCP4:k8s.whydontyou.work:6443"
          ports:
            - containerPort: 7446
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
          resources:
            requests:
              cpu: 5m
              memory: 8Mi
            limits:
              memory: 32Mi
