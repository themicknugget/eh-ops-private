---
# Injects PROXY protocol listener filter into Cilium-managed Envoy configs for the
# cloudbox gateways. nginx on cloudbox nodes sends PROXY protocol headers so Envoy
# can populate X-Forwarded-For with the real client IP rather than the nginx node IP.
# proxy_protocol must precede tls_inspector so Envoy reads the PP header before
# inspecting the TLS ClientHello.
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cloudbox-gateway-proxy-protocol
spec:
  background: true
  rules:
    - name: add-proxy-protocol-listener-filter
      match:
        any:
          - resources:
              kinds:
                - CiliumEnvoyConfig
              names:
                - cilium-gateway-cloudbox-gateway
                - cilium-gateway-cloudbox3-gateway
              namespaces:
                - kube-system
      mutate:
        patchesJson6902: |-
          - op: replace
            path: /spec/resources/0/listenerFilters
            value:
              - name: envoy.filters.listener.proxy_protocol
                typedConfig:
                  '@type': type.googleapis.com/envoy.extensions.filters.listener.proxy_protocol.v3.ProxyProtocol
              - name: envoy.filters.listener.tls_inspector
                typedConfig:
                  '@type': type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
