---
# On edge nodes (where kube-api-proxy runs), redirect all pod traffic destined for
# the kubernetes ClusterIP (10.96.0.1:443) to the local socat proxy, which forwards
# to k8s.whydontyou.work:6443. On LAN nodes (no proxy pod), this policy has no
# effect and normal ClusterIP routing to 192.168.1.51-53 applies.
apiVersion: cilium.io/v2
kind: CiliumLocalRedirectPolicy
metadata:
  name: kube-api-edge
  namespace: kube-system
spec:
  redirectFrontend:
    serviceMatcher:
      serviceName: kubernetes
      namespace: default
      toPorts:
        - port: "443"
          protocol: TCP
  redirectBackend:
    localEndpointSelector:
      matchLabels:
        app: kube-api-proxy
    toPorts:
      - port: "7446"
        protocol: TCP
