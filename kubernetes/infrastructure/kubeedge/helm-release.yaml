---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudcore
  namespace: kube-system
spec:
  interval: 30m
  chart:
    spec:
      # KubeEdge doesn't have a Helm repo, use GitRepository
      chart: ./manifests/charts/cloudcore
      sourceRef:
        kind: GitRepository
        name: kubeedge
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    image:
      repository: kubeedge/cloudcore
      tag: "v1.22.1"
      pullPolicy: IfNotPresent

    replicas: 2

    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: node-role.kubernetes.io/control-plane
                  operator: Exists
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: k8s-app
                    operator: In
                    values:
                      - kubeedge
              topologyKey: kubernetes.io/hostname

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    cloudHub:
      advertiseAddress:
        # LoadBalancer IP for edge node connections
        - 192.168.1.66
        # Accessible via Tailscale subnet router (192.168.1.64/28)
        # Edge nodes connect through existing Tailscale infrastructure
        - 0.0.0.0
      dnsNames:
        - 192.168.1.66
      port: 10350
      websocket:
        enable: true
        port: 10000
      quic:
        enable: true
        port: 10001
      https:
        enable: true

    cloudStream:
      enable: false

    dynamicController:
      enable: true

    featureGates:
        NodeLazyConnectivity: true

    # Disable iptables-manager - incompatible with Cilium eBPF mode
    # Cilium doesn't provide traditional iptables nat table when using eBPF
    iptablesManager:
      enable: false
