{{- if and .Values.name .Values.download.enabled -}}
{{- $modelDir := .Values.storage.modelDir | default .Values.name -}}
{{- $sharedPvc := .Values.storage.sharedPvc | default "model-cache" -}}
# Launcher Job - creates the actual download job and exits
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.name }}-download
  labels:
    {{- include "inference-model.labels" . | nindent 4 }}
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "inference-model.labels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ .Values.name }}-download-launcher
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      restartPolicy: OnFailure
      containers:
        - name: launcher
          image: bitnami/kubectl:latest
          command:
            - sh
            - -c
            - |
              set -e

              MODEL_DIR=/models/{{ $modelDir }}
              JOB_NAME={{ .Values.name }}-download-worker
              NAMESPACE={{ .Release.Namespace }}

              # Check if already downloaded - fast exit
              if [ -f "${MODEL_DIR}/.ready" ]; then
                echo "Model already downloaded"
                exit 0
              fi

              echo "Ensuring download worker job is running..."

              # Delete any existing worker job (and its pods)
              kubectl delete job "${JOB_NAME}" -n "${NAMESPACE}" --ignore-not-found=true --force --grace-period=0 2>/dev/null || true

              # Wait for pods to be cleaned up
              sleep 2

              # Create the actual download job
              cat <<JOBEOF | kubectl apply -f -
              apiVersion: batch/v1
              kind: Job
              metadata:
                name: ${JOB_NAME}
                namespace: ${NAMESPACE}
                labels:
                  app.kubernetes.io/name: {{ .Values.name }}
                  app.kubernetes.io/component: download-worker
                  app.kubernetes.io/managed-by: {{ .Values.name }}-download
              spec:
                backoffLimit: 3
                ttlSecondsAfterFinished: 3600
                template:
                  metadata:
                    labels:
                      app.kubernetes.io/name: {{ .Values.name }}
                      app.kubernetes.io/component: download-worker
                  spec:
                    {{- with .Values.nodeSelector }}
                    nodeSelector:
                      {{- toYaml . | nindent 20 }}
                    {{- end }}
                    {{- with .Values.tolerations }}
                    tolerations:
                      {{- toYaml . | nindent 20 }}
                    {{- end }}
                    restartPolicy: OnFailure
                    containers:
                      - name: download
                        image: python:3.11-slim
                        command:
                          - sh
                          - -c
                          - |
                            set -e

                            # Install huggingface-cli with CLI extras
                            pip install --user "huggingface_hub[cli]"
                            export PATH="/tmp/.local/bin:\$PATH"

                            MODEL_DIR=/models/{{ $modelDir }}

                            # Check if already downloaded
                            if [ -f "\${MODEL_DIR}/.ready" ]; then
                              echo "Model already downloaded"
                              exit 0
                            fi

                            # Create lock file
                            mkdir -p "\${MODEL_DIR}"
                            touch "\${MODEL_DIR}/.downloading"

                            # Background: update lock timestamp every minute
                            while true; do
                              touch "\${MODEL_DIR}/.downloading"
                              sleep 60
                            done &
                            heartbeat_pid=\$!

                            # Background: print download progress every 60s with transfer rate
                            last_bytes=0
                            while [ ! -f "\${MODEL_DIR}/.ready" ]; do
                              bytes=\$(du -sb "\${MODEL_DIR}" 2>/dev/null | cut -f1)
                              if [ -n "\$bytes" ] && [ "\$last_bytes" -gt 0 ]; then
                                diff=\$((bytes - last_bytes))
                                size_gb=\$((bytes / 1024 / 1024 / 1024))
                                rate_mb=\$((diff / 60 / 1024 / 1024))
                                if [ "\$rate_mb" -ge 1 ]; then
                                  echo "\${size_gb}G downloaded (~\${rate_mb} MB/s)"
                                else
                                  rate_kb=\$((diff / 60 / 1024))
                                  echo "\${size_gb}G downloaded (~\${rate_kb} KB/s)"
                                fi
                              elif [ -n "\$bytes" ]; then
                                size_gb=\$((bytes / 1024 / 1024 / 1024))
                                echo "\${size_gb}G downloaded"
                              fi
                              last_bytes=\${bytes:-0}
                              sleep 60
                            done &
                            progress_pid=\$!

                            echo "Downloading model to \${MODEL_DIR}..."

                            # Download (hf is resumable)
                            hf download "{{ .Values.source.huggingface }}" \\
                              --local-dir "\${MODEL_DIR}"

                            # Mark complete
                            kill \$heartbeat_pid \$progress_pid 2>/dev/null || true
                            rm -f "\${MODEL_DIR}/.downloading"
                            touch "\${MODEL_DIR}/.ready"

                            echo "Model downloaded successfully!"
                        env:
                          - name: HF_HOME
                            value: /models
                          - name: HOME
                            value: /tmp
                          {{- if .Values.download.tokenSecret }}
                          - name: HF_TOKEN
                            valueFrom:
                              secretKeyRef:
                                name: {{ .Values.download.tokenSecret }}
                                key: {{ .Values.download.tokenSecretKey | default "token" }}
                          {{- end }}
                        volumeMounts:
                          - name: model-cache
                            mountPath: /models
                          - name: tmp
                            mountPath: /tmp
                    volumes:
                      - name: model-cache
                        persistentVolumeClaim:
                          claimName: {{ $sharedPvc }}
                      - name: tmp
                        emptyDir: {}
              JOBEOF

              echo "Download worker job created successfully!"
          volumeMounts:
            - name: model-cache
              mountPath: /models
      volumes:
        - name: model-cache
          persistentVolumeClaim:
            claimName: {{ $sharedPvc }}
{{- end -}}
