---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudcore
  namespace: kube-system
spec:
  interval: 30m
  chart:
    spec:
      # KubeEdge doesn't have a Helm repo, use GitRepository
      chart: ./manifests/charts/cloudcore
      sourceRef:
        kind: GitRepository
        name: kubeedge
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    image:
      repository: kubeedge/cloudcore
      tag: "v1.21.0"
      pullPolicy: IfNotPresent

    replicas: 2

    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - cloudcore
              topologyKey: kubernetes.io/hostname

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    cloudHub:
      advertiseAddress:
        # Accessible via Tailscale subnet router (192.168.1.64/28)
        # Edge nodes connect through existing Tailscale infrastructure
        - 0.0.0.0
      port: 10350
      websocket:
        enable: true
        port: 10000
      quic:
        enable: true
        port: 10001
      https:
        enable: true

    cloudStream:
      enable: false

    dynamicController:
      enable: true

    featureGates:
        NodeLazyConnectivity: true
