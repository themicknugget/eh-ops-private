---
# ServiceAccount for external-dns
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-dns
  namespace: dns-system
---
# ClusterRole with permissions to watch Gateway API resources
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns
rules:
  # Watch services, pods, nodes, endpoints
  - apiGroups: [""]
    resources: ["services", "pods", "nodes", "endpoints"]
    verbs: ["get", "watch", "list"]
  # Watch ingresses
  - apiGroups: ["extensions", "networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get", "watch", "list"]
  # Watch Gateway API resources
  - apiGroups: ["gateway.networking.k8s.io"]
    resources: ["gateways", "httproutes", "grpcroutes", "tlsroutes", "tcproutes", "udproutes"]
    verbs: ["get", "watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns
subjects:
  - kind: ServiceAccount
    name: external-dns
    namespace: dns-system
---
# external-dns deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns
  namespace: dns-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: external-dns
  template:
    metadata:
      labels:
        app: external-dns
    spec:
      serviceAccountName: external-dns
      containers:
        - name: external-dns
          image: registry.k8s.io/external-dns/external-dns:v0.15.0
          args:
            # Source: Watch HTTPRoute resources (Gateway API)
            - --source=gateway-httproute
            # Provider: CoreDNS via etcd
            - --provider=coredns
            # Domain filters - manage all configured domains
            - --domain-filter=${DOMAIN1}
            - --domain-filter=${DOMAIN2}
            - --domain-filter=${DOMAIN3}
            # TXT record ownership for multi-cluster support
            - --txt-owner-id=eh-ops-cluster
            - --txt-prefix=_externaldns.
            # Sync policy (upsert-only or sync)
            - --policy=upsert-only
            # Interval between syncs
            - --interval=1m
            # Logging
            - --log-level=info
            - --log-format=text
          env:
            - name: ETCD_URLS
              value: "http://etcd.dns-system.svc.cluster.local:2379"
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
